<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QRコード表示</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="icon" href="./icons/icon-512.png" sizes="512x512">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 0; padding: 1rem; background: #fff; text-align: center; }
    h1 { font-size: 1.2rem; margin: 1rem 0; }
    .qr-block { margin: 2rem 0; }
    .qrcode { margin-top: 1rem; }
    .download-btn {
      display: none; /* 初期状態では非表示 */
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 8px;
      background: #0ea5e9;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>QRコード表示</h1>

  <div class="qr-block">
    <div id="label1"></div>
    <div id="qrcode1" class="qrcode"></div>
    <button id="download1" class="download-btn">画像を保存</button>
  </div>

  <div class="qr-block">
    <div id="label2"></div>
    <div id="qrcode2" class="qrcode"></div>
    <button id="download2" class="download-btn">画像を保存</button>
  </div>

  <script defer src="./qrcode.min.js"></script>
  <script>
    function generateQR(text, size, ec, target, downloadButtonId, defaultLabel) {
      target.innerHTML = "";
      if (!text.trim()) {
        document.getElementById(downloadButtonId).style.display = 'none';
        return;
      }
      
      const qrcode = new QRCode(target, {
        text: text,
        width: parseInt(size, 10),
        height: parseInt(size, 10),
        correctLevel: QRCode.CorrectLevel[ec] || QRCode.CorrectLevel.M
      });
      
      // QRコードが生成された後にダウンロードボタンを表示
      const downloadButton = document.getElementById(downloadButtonId);
      downloadButton.style.display = 'inline-block';
      
      // ダウンロード機能
      downloadButton.onclick = () => {
        // qrcode.jsが生成するimgまたはcanvas要素を取得
        const qrCanvas = target.querySelector('canvas');
        const qrImg = target.querySelector('img');

        if (qrCanvas) {
            const imageData = qrCanvas.toDataURL("image/png");
            const a = document.createElement('a');
            a.href = imageData;
            a.download = (defaultLabel || 'qr_code') + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else if (qrImg) {
            const a = document.createElement('a');
            a.href = qrImg.src;
            a.download = (defaultLabel || 'qr_code') + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
      };
    }

    // URLパラメータから取得
    const params = new URLSearchParams(window.location.search);

    // QR1
    const label1 = params.get("label1") || "";
    document.getElementById("label1").textContent = label1;
    generateQR(
      params.get("text1") || "",
      params.get("size1") || "512",
      params.get("ec1") || "M",
      document.getElementById("qrcode1"),
      "download1",
      label1
    );

    // QR2
    const label2 = params.get("label2") || "";
    document.getElementById("label2").textContent = label2;
    generateQR(
      params.get("text2") || "",
      params.get("size2") || "512",
      params.get("ec2") || "M",
      document.getElementById("qrcode2"),
      "download2",
      label2
    );
  </script>
</body>
</html>
